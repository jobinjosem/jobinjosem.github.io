<!doctype html><html lang="en" ><head> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4445781280689625" crossorigin="anonymous"></script> <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Azure Workload Identity on Kubernetes" /><meta property="og:locale" content="en" /><meta name="description" content="Deployed workloads within Kubernetes clusters necessitate Azure AD application credentials or managed identities for accessing Azure AD protected resources, like Azure Key Vault and Microsoft Graph. Azure AD Pod Identity, previously offered a means to circumvent the requirement for such secrets through the utilization of Azure managed identities.The open source Azure AD pod-managed identity in AKS has been deprecated and the project will be archived soon. Azure AD workload identity replaces pod-managed identity." /><meta property="og:description" content="Deployed workloads within Kubernetes clusters necessitate Azure AD application credentials or managed identities for accessing Azure AD protected resources, like Azure Key Vault and Microsoft Graph. Azure AD Pod Identity, previously offered a means to circumvent the requirement for such secrets through the utilization of Azure managed identities.The open source Azure AD pod-managed identity in AKS has been deprecated and the project will be archived soon. Azure AD workload identity replaces pod-managed identity." /><link rel="canonical" href="https://www.devopsnest.com/azure/2023/08/24/azure-workload-identity.html" /><meta property="og:url" content="https://www.devopsnest.com/azure/2023/08/24/azure-workload-identity.html" /><meta property="og:site_name" content="Jobin Jose" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-08-24T11:12:22+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Azure Workload Identity on Kubernetes" /><meta name="twitter:site" content="@jobinjosem" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-24T11:12:22+02:00","datePublished":"2023-08-24T11:12:22+02:00","description":"Deployed workloads within Kubernetes clusters necessitate Azure AD application credentials or managed identities for accessing Azure AD protected resources, like Azure Key Vault and Microsoft Graph. Azure AD Pod Identity, previously offered a means to circumvent the requirement for such secrets through the utilization of Azure managed identities.The open source Azure AD pod-managed identity in AKS has been deprecated and the project will be archived soon. Azure AD workload identity replaces pod-managed identity.","headline":"Azure Workload Identity on Kubernetes","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.devopsnest.com/azure/2023/08/24/azure-workload-identity.html"},"url":"https://www.devopsnest.com/azure/2023/08/24/azure-workload-identity.html"}</script><title>Azure Workload Identity on Kubernetes | Jobin Jose</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jobin Jose"><meta name="application-name" content="Jobin Jose"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } }, tex2jax: { inlineMath: [ ['$', '$'] ], displayMath: [ ['$$', '$$'], ['\\[', '\\]'] ], processEscapes: true, } }); MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) { alert("Math Processing Error: "+message[1]); }); MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) { alert("Math Processing Error: "+message[1]); }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" ></script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/jobin.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">Jobin Jose</a></div><div class="site-subtitle fst-italic">..that regular things, but in my own voice...</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul><div class="align-items-center w-100" style="text-align: center; margin-bottom: 1rem;"> <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fjobinjosem.github.io&count_bg=%23555555&title_bg=%23242424&icon=myspace.svg&icon_color=%23E7E7E7&title=Visitors&edge_flat=false" /></div><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jobinjosem" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jobinjosem" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['jobinjosem','hotmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Azure Workload Identity on Kubernetes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><link rel="stylesheet" href="https://unpkg.com/applause-button/dist/applause-button.css"> <script src="https://unpkg.com/applause-button/dist/applause-button.js"></script><h1 data-toc-skip>Azure Workload Identity on Kubernetes</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1692868342" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 24, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/jobinjosem">Jobin Jose</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="627 words" > <em>3 min</em> read</span></div></div></div><div class="post-content"><p>Deployed workloads within Kubernetes clusters necessitate Azure AD application credentials or managed identities for accessing Azure AD protected resources, like Azure Key Vault and Microsoft Graph. Azure AD Pod Identity, previously offered a means to circumvent the requirement for such secrets through the utilization of Azure managed identities.The open source Azure AD pod-managed identity in AKS has been deprecated and the project will be archived soon. Azure AD workload identity replaces pod-managed identity.</p><p>In contrast, Azure AD Workload Identity for Kubernetes seamlessly incorporates the Kubernetes capabilities to establish federation with external identity providers. This method is much more simpler and removes the complexity of AAD Pod Identities.</p><h2 id="authentication-sequence-using-oidc"><span class="me-2">Authentication Sequence using OIDC</span><a href="#authentication-sequence-using-oidc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/assets/img/aks-workload-identity-oidc-authentication-model.png" class="popup img-link "><img data-src="/assets/img/aks-workload-identity-oidc-authentication-model.png" alt="Authentication Sequence" class="lazyload" data-proofer-ignore></a> <em>Courtesy: microsoft.com</em></p><h2 id="how-to-deploy-and-configure-aks-cluster"><span class="me-2">How to deploy and configure AKS cluster</span><a href="#how-to-deploy-and-configure-aks-cluster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://learn.microsoft.com/en-us/azure/aks/workload-identity-deploy-cluster">Microsoft Docs - workload-identity-deploy-cluster</a></p><h2 id="how-to-retrieve-the-oidc-issuer-url"><span class="me-2">How to retrieve the OIDC Issuer URL</span><a href="#how-to-retrieve-the-oidc-issuer-url" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>az aks show <span class="nt">-n</span> myAKSCluster <span class="nt">-g</span> <span class="s2">"</span><span class="k">${</span><span class="nv">RESOURCE_GROUP</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"oidcIssuerProfile.issuerUrl"</span> <span class="nt">-otsv</span>
</pre></table></code></div></div><p class="nolineno">By default, the Issuer is set to use the base URL <em>https://{region}.oic.prod-aks.azure.com/{uuid}</em> where the value for {region} matches the location the AKS cluster is deployed in. The value {uuid} represents the OIDC key.</p><h2 id="oidc-endpoints"><span class="me-2">OIDC Endpoints</span><a href="#oidc-endpoints" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><p><strong>{IssuerURL}/.well-known/openid-configuration</strong> Also known as the OIDC discovery document. This contains the metadata about the issuer’s configurations.</p><li><p><strong>{IssuerURL}/openid/v1/jwks</strong> This contains the public signing key(s) that AAD uses to verify the authenticity of the service account token.</p></ul><h2 id="create-federated-identity-credential"><span class="me-2">Create Federated identity credential</span><a href="#create-federated-identity-credential" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>az identity federated-credential create <span class="nt">--name</span> <span class="k">${</span><span class="nv">FEDERATED_IDENTITY_CREDENTIAL_NAME</span><span class="k">}</span> <span class="nt">--identity-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--resource-group</span> <span class="s2">"</span><span class="k">${</span><span class="nv">RESOURCE_GROUP</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--issuer</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AKS_OIDC_ISSUER</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--subject</span> system:serviceaccount:<span class="s2">"</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="k">}</span><span class="s2">"</span>:<span class="s2">"</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--audience</span> api://AzureADTokenExchange
</pre></table></code></div></div><h2 class="nolineno" id="service-account-token-mount-location">Service Account token mount location</h2><p>The azure identity token is mounted at below location by default but this can be changed in the pod manifests.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/var/run/secrets/azure/tokens/azure-identity-token
</pre></table></code></div></div><blockquote class="prompt-info"><p>The regular kubernetes serviceaccount token is mounted at: /var/run/secrets/kubernetes.io/serviceaccount</p></blockquote><h2 id="environment-variables"><span class="me-2">Environment Variables</span><a href="#environment-variables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>AZURE_AUTHORITY_HOST</strong> The Azure Active Directory (AAD) endpoint.<li><strong>AZURE_CLIENT_ID</strong> The client ID of the AAD application or user-assigned managed identity.<li><strong>AZURE_TENANT_ID</strong> The tenant ID of the registered AAD application or user-assigned managed identity.<li><strong>AZURE_FEDERATED_TOKEN_FILE</strong> The path of the projected service account token file.</ul><h2 id="volume-injected-by-the-webhook"><span class="me-2">Volume injected by the webhook</span><a href="#volume-injected-by-the-webhook" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>azure-identity-token</strong> The projected service account volume.</ul><blockquote><p>These values can be verified by running kubectl describe pod command</p></blockquote><h2 id="jump-pod-manifest-for-verifying-kubernetes-service-account-token"><span class="me-2">Jump pod manifest for verifying Kubernetes service account token</span><a href="#jump-pod-manifest-for-verifying-kubernetes-service-account-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="s">cat &lt;&lt;EOF | kubectl apply -f -</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">jump</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">${NAMESPACE}</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">smallstep/step-cli</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">step-cli</span>
    <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/bin/sh</span>
    <span class="pi">-</span> <span class="s">-c</span>
    <span class="pi">-</span> <span class="s">cat /var/run/secrets/tokens/test-token | step crypto jwt inspect --insecure</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/secrets/tokens</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">test-token</span>
  <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">${SERVICE_ACCOUNT_NAME}</span>
  <span class="na">volumes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">test-token</span>
    <span class="na">projected</span><span class="pi">:</span>
      <span class="na">sources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">serviceAccountToken</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">test-token</span>
          <span class="na">expirationSeconds</span><span class="pi">:</span> <span class="m">3600</span>
          <span class="na">audience</span><span class="pi">:</span> <span class="s">test</span>
<span class="s">EOF</span>
</pre></table></code></div></div><p>The jump pod logs will contain the decoded JWT.</p><blockquote class="prompt-info"><p>Note that the values like audience, expirationSeconds etc can be customized in the manifest while the azure-identity-token behaviour can be modified adding custom labels on the pod.</p></blockquote><h2 id="jump-pod-for-verifying-access-token"><span class="me-2">Jump pod for verifying access token</span><a href="#jump-pod-for-verifying-access-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>kubectl run az-cli <span class="nt">-n</span> default <span class="nt">-l</span> <span class="s2">"azure.workload.identity/use=true"</span> <span class="nt">--image</span><span class="o">=</span>mcr.microsoft.com/azure-cli <span class="nt">-i</span> <span class="nt">--tty</span> <span class="nt">--rm</span> <span class="nt">--command</span> /usr/bin/env <span class="nt">--overrides</span><span class="o">=</span><span class="s1">'{"spec": { "serviceAccount": "workload-identity-sa" }}'</span> <span class="nt">--</span> sh
az login <span class="nt">--federated-token</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$AZURE_FEDERATED_TOKEN_FILE</span><span class="si">)</span><span class="s2">"</span> <span class="nt">--service-principal</span> <span class="nt">-u</span> <span class="nv">$AZURE_CLIENT_ID</span> <span class="nt">-t</span> <span class="nv">$AZURE_TENANT_ID</span>
az account get-access-token
</pre></table></code></div></div><h2 id="how-to-check-the-pod-is-labeled"><span class="me-2">How to check the pod is labeled</span><a href="#how-to-check-the-pod-is-labeled" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl get pods <span class="nt">-A</span> <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'["Namespace", "Pod-Name"], (.items[] | select(.metadata.labels."azure.workload.identity/use" == "true") | [.metadata.namespace, .metadata.name]) | @tsv'</span> | column <span class="nt">-t</span>
</pre></table></code></div></div><h2 id="get-all-deployments-with-the-labels-on"><span class="me-2">Get all deployments with the labels on</span><a href="#get-all-deployments-with-the-labels-on" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl get deployments <span class="nt">--all-namespaces</span> <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.items[] | select(.spec.template.metadata.labels."azure.workload.identity/use" == "true") | "\(.metadata.namespace) \(.metadata.name)"'</span>
</pre></table></code></div></div><h2 id="token-comparison"><span class="me-2">Token comparison</span><a href="#token-comparison" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Displayed below are three decoded tokens arranged side by side: the first is a standard service account token, the middle one represents an Azure identity token, and the third corresponds to an Azure access token. <a href="/assets/img/token-comparison.png" class="popup img-link "><img data-src="/assets/img/token-comparison.png" alt="Token Comparison" class="lazyload" data-proofer-ignore></a></p><h2 id="limitations"><span class="me-2">Limitations</span><a href="#limitations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>You can only have 20 federated identity credentials per managed identity.</ul><h2 id="bookmarks"><span class="me-2">Bookmarks</span><a href="#bookmarks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://learn.microsoft.com/en-us/azure/aks/workload-identity-overview?tabs=dotnet">Microsoft Docs</a></p><p><a href="https://azure.github.io/azure-workload-identity/docs/">Azure Workload Identity Gihub Pages</a></p><p><a href="https://github.com/HoussemDellai/docker-kubernetes-course/tree/main/23_workload_identity">Deploy Script</a></p><p><a href="https://github.com/Azure/azure-workload-identity/tree/main/examples/msal-go">Sample Application</a></p></div><div class="post-tail-wrapper text-muted"><div class="applause-button"> <applause-button class="mb6" color=rgb(79,177,186) url=https://www.devopsnest.com/azure/2023/08/24/azure-workload-identity.html> </applause-button></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/azure/'>Azure</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/azure/" class="post-tag no-text-decoration">azure</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration">kubernetes</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Azure%20Workload%20Identity%20on%20Kubernetes%20-%20Jobin%20Jose&url=https%3A%2F%2Fwww.devopsnest.com%2Fazure%2F2023%2F08%2F24%2Fazure-workload-identity.html" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Azure%20Workload%20Identity%20on%20Kubernetes%20-%20Jobin%20Jose&u=https%3A%2F%2Fwww.devopsnest.com%2Fazure%2F2023%2F08%2F24%2Fazure-workload-identity.html" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.devopsnest.com%2Fazure%2F2023%2F08%2F24%2Fazure-workload-identity.html&text=Azure%20Workload%20Identity%20on%20Kubernetes%20-%20Jobin%20Jose" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/backstage/">backstage</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/mkdcos/">mkdcos</a> <a class="post-tag btn btn-outline-primary" href="/tags/wsl/">wsl</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/technical-writing/ai/2023/09/15/templates-backstage.html" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1694787480" data-df="ll" > Sep 15, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>Templates in Backstage</h4><div class="text-muted small"><p></p></div></div></a></div><div class="col"> <a href="/wsl/2022/03/01/oh-my-posh-bash.html" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1646125942" data-df="ll" > Mar 1, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>WSL Bash customization using oh-my-posh</h4><div class="text-muted small"><p> In this post, I will explain how I tweaked my bash prompt in WSL using oh-my-posh. Below are the steps I followed to personalize my bash shell. Install oh-my-posh. sudo wget https://github.com/Ja...</p></div></div></a></div><div class="col"> <a href="/technical-writing/backstage/2023/09/01/techdocs-backstage.html" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1693519200" data-df="ll" > Sep 1, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>TechDocs in Backstage</h4><div class="text-muted small"><p> What is TechDocs? TechDocs is Spotify’s in-house solution for documentation-as-code, seamlessly integrated into Backstage. It aligns with the “docs like code” philosophy, where documentation is aut...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2022/04/12/maintain-static-website.html" class="btn btn-outline-primary" prompt="Older" ><p>Unveiling the Construction of This Blog</p></a> <a href="/technical-writing/backstage/2023/09/01/techdocs-backstage.html" class="btn btn-outline-primary" prompt="Newer" ><p>TechDocs in Backstage</p></a></div><script src="https://utteranc.es/client.js" repo="jobinjosem/jobinjosem.github.io" issue-term="pathname" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/backstage/">backstage</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/mkdcos/">mkdcos</a> <a class="post-tag btn btn-outline-primary" href="/tags/wsl/">wsl</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a></p><p>© 2023 <a href="https://twitter.com/jobinjosem">Jobin Jose</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
